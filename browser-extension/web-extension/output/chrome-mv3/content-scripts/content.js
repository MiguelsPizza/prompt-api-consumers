var content=function(){"use strict";var j=Object.defineProperty;var x=(o,a,f)=>a in o?j(o,a,{enumerable:!0,configurable:!0,writable:!0,value:f}):o[a]=f;var h=(o,a,f)=>x(o,typeof a!="symbol"?a+"":a,f);var I,T;const o=((T=(I=globalThis.browser)==null?void 0:I.runtime)==null?void 0:T.id)==null?globalThis.chrome:globalThis.browser;function a(r,...e){}const f={debug:(...r)=>a(console.debug,...r),log:(...r)=>a(console.log,...r),warn:(...r)=>a(console.warn,...r),error:(...r)=>a(console.error,...r)},w=class w extends Event{constructor(e,t){super(w.EVENT_NAME,{}),this.newUrl=e,this.oldUrl=t}};h(w,"EVENT_NAME",v("wxt:locationchange"));let b=w;function v(r){var e;return`${(e=o==null?void 0:o.runtime)==null?void 0:e.id}:content:${r}`}function K(r){let e,t;return{run(){e==null&&(t=new URL(location.href),e=r.setInterval(()=>{let n=new URL(location.href);n.href!==t.href&&(window.dispatchEvent(new b(n,t)),t=n)},1e3))}}}const g=class g{constructor(e,t){h(this,"isTopFrame",window.self===window.top);h(this,"abortController");h(this,"locationWatcher",K(this));h(this,"receivedMessageIds",new Set);this.contentScriptName=e,this.options=t,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(e){return this.abortController.abort(e)}get isInvalid(){return o.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(e){return this.signal.addEventListener("abort",e),()=>this.signal.removeEventListener("abort",e)}block(){return new Promise(()=>{})}setInterval(e,t){const n=setInterval(()=>{this.isValid&&e()},t);return this.onInvalidated(()=>clearInterval(n)),n}setTimeout(e,t){const n=setTimeout(()=>{this.isValid&&e()},t);return this.onInvalidated(()=>clearTimeout(n)),n}requestAnimationFrame(e){const t=requestAnimationFrame((...n)=>{this.isValid&&e(...n)});return this.onInvalidated(()=>cancelAnimationFrame(t)),t}requestIdleCallback(e,t){const n=requestIdleCallback((...s)=>{this.signal.aborted||e(...s)},t);return this.onInvalidated(()=>cancelIdleCallback(n)),n}addEventListener(e,t,n,s){var i;t==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(i=e.addEventListener)==null||i.call(e,t.startsWith("wxt:")?v(t):t,n,{...s,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),f.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:g.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(e){var i,d,p;const t=((i=e.data)==null?void 0:i.type)===g.SCRIPT_STARTED_MESSAGE_TYPE,n=((d=e.data)==null?void 0:d.contentScriptName)===this.contentScriptName,s=!this.receivedMessageIds.has((p=e.data)==null?void 0:p.messageId);return t&&n&&s}listenForNewerScripts(e){let t=!0;const n=s=>{if(this.verifyScriptStartedEvent(s)){this.receivedMessageIds.add(s.data.messageId);const i=t;if(t=!1,i&&(e!=null&&e.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",n),this.onInvalidated(()=>removeEventListener("message",n))}};h(g,"SCRIPT_STARTED_MESSAGE_TYPE",v("wxt:content-script-started"));let S=g;const P=Symbol("null");let N=0;class R extends Map{constructor(){super(),this._objectHashes=new WeakMap,this._symbolHashes=new Map,this._publicKeys=new Map;const[e]=arguments;if(e!=null){if(typeof e[Symbol.iterator]!="function")throw new TypeError(typeof e+" is not iterable (cannot read property Symbol(Symbol.iterator))");for(const[t,n]of e)this.set(t,n)}}_getPublicKeys(e,t=!1){if(!Array.isArray(e))throw new TypeError("The keys parameter must be an array");const n=this._getPrivateKey(e,t);let s;return n&&this._publicKeys.has(n)?s=this._publicKeys.get(n):t&&(s=[...e],this._publicKeys.set(n,s)),{privateKey:n,publicKey:s}}_getPrivateKey(e,t=!1){const n=[];for(let s of e){s===null&&(s=P);const i=typeof s=="object"||typeof s=="function"?"_objectHashes":typeof s=="symbol"?"_symbolHashes":!1;if(!i)n.push(s);else if(this[i].has(s))n.push(this[i].get(s));else if(t){const d=`@@mkm-ref-${N++}@@`;this[i].set(s,d),n.push(d)}else return!1}return JSON.stringify(n)}set(e,t){const{publicKey:n}=this._getPublicKeys(e,!0);return super.set(n,t)}get(e){const{publicKey:t}=this._getPublicKeys(e);return super.get(t)}has(e){const{publicKey:t}=this._getPublicKeys(e);return super.has(t)}delete(e){const{publicKey:t,privateKey:n}=this._getPublicKeys(e);return!!(t&&super.delete(t)&&this._publicKeys.delete(n))}clear(){super.clear(),this._symbolHashes.clear(),this._publicKeys.clear()}get[Symbol.toStringTag](){return"ManyKeysMap"}get size(){return super.size}}new R;async function E(r,e){const t=o.runtime.getURL(r),n=document.createElement("script");o.runtime.getManifest().manifest_version===2?n.innerHTML=await fetch(t).then(s=>s.text()):n.src=t,e!=null&&e.keepInDom||(n.onload=()=>n.remove()),(document.head??document.documentElement).append(n)}function U(r){return r}function k(r,e={}){const{debug:t=!1,enforceSameOrigin:n=!0}=e,s=new Set;function i(l){var M;if(n&&l.origin!==window.location.origin){t&&console.warn(`%c[Relay] Rejected message from different origin: ${l.origin}`,"color: orange;");return}const u=(M=l.data)==null?void 0:M.trpc;if(!u)return;const{id:c,method:m,result:A,error:D}=u,$=!!m,C=!m&&(A!==void 0||D!==void 0);if($){c!=null&&s.add(c),t&&console.debug(`%c[Window → BGSW] Forwarding request. ID: ${c}, method: ${m}`,"color: teal;"),r.postMessage({trpc:u});return}if(C){if(c!=null&&!s.has(c)){t&&console.debug(`%c[Relay] Ignoring response ${c} because request is not in flight.`,"color: #999;");return}c!=null&&s.delete(c);return}t&&console.debug("[Relay] Unknown message shape, ignoring.",u)}function d(l){if(!(l!=null&&l.trpc))return;const{id:u,result:c,error:m}=l.trpc;u!==void 0&&s.has(u)&&s.delete(u),t&&console.debug(`%c[BGSW → Window] Sending response for ID: ${u}`,"color: purple;","result:",c,"error:",m),window.postMessage(l,"*")}function p(){t&&console.warn("%c[Relay] Port disconnected, cleaning up listeners.","color: red;"),_()}function _(){window.removeEventListener("message",i),r.onMessage.removeListener(d),r.onDisconnect.removeListener(p),r.disconnect()}return window.addEventListener("message",i),r.onMessage.addListener(d),r.onDisconnect.addListener(p),_}const F={matches:["<all_urls>"],async main(r){const e=chrome.runtime.connect({name:"web_llm_service_worker"}),t=k(e,{debug:!0,enforceSameOrigin:!1});try{await E("/injectDownloadTracker.js",{keepInDom:!0}),console.log("[Content] Successfully injected download tracker"),await E("/injectPolyfill.js",{keepInDom:!0})}catch(n){throw console.error("[Content] Failed to inject script:",n),t(),n}}};function W(){}function y(r,...e){}const L={debug:(...r)=>y(console.debug,...r),log:(...r)=>y(console.log,...r),warn:(...r)=>y(console.warn,...r),error:(...r)=>y(console.error,...r)};return(async()=>{try{const{main:r,...e}=F,t=new S("content",e);return await r(t)}catch(r){throw L.error('The content script "content" crashed on startup!',r),r}})()}();
content;
